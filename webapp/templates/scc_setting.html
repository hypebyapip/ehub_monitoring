{% extends 'base.html' %}
{% block title %}SCC Network Settings{% endblock %}
{% block content %}
<div class="container mx-auto p-6">
  <div class="flex justify-end items-center space-x-2 border rounded-lg p-2 w-fit ml-auto">
    <button id="decrease" class="px-3 py-1 border rounded">-</button>
    <input id="counter" type="number" class="w-10 text-center border rounded" value="0">
    <button id="increase" class="px-3 py-1 border rounded">+</button>
    <button id="add" class="px-6 py-1 bg-green-500 text-white border rounded-md">Add</button>
  </div>

  <div id="network-settings-container" class="grid grid-cols-2 gap-4 mt-4">
    {% for scc in scc_list %}
    <div class="bg-white rounded-lg shadow p-4 relative" data-scc-number="{{ scc.scc_number }}">
      <div class="flex justify-between items-center border-b pb-2 mb-2">
        <h3 class="text-lg font-semibold">SCC{{ scc.scc_number }}</h3>
        <div class="flex items-center space-x-2">
          <label class="switch">
            <input type="checkbox" class="toggle-switch" {% if scc.is_active %}checked{% endif %}>
            <span class="slider round"></span>
          </label>
          <button class="remove-card text-gray-500 text-xl">&times;</button>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">IP Address</label>
        <input type="text" class="w-full p-1 border rounded input-field" value="{{ scc.ip_address }}" {% if not scc.is_active %}disabled{% endif %}>
      </div>
      <div class="mt-2">
        <label class="block text-sm font-medium text-gray-700">Modbus Address</label>
        <input type="text" class="w-full p-1 border rounded input-field" value="{{ scc.modbus_address }}" {% if not scc.is_active %}disabled{% endif %}>
      </div>
      <div class="mt-4 flex justify-end space-x-2">
        <button class="save-btn px-4 py-2 bg-green-500 text-white rounded">Save</button>
        <button class="refresh-btn px-4 py-2 bg-blue-500 text-white rounded">Refresh</button>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="confirmation-modal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
      <p class="text-lg font-semibold mb-4">Are you sure you want to delete this card?</p>
      <div class="flex justify-center space-x-4">
        <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded">Yes</button>
        <button id="cancel-delete" class="px-4 py-2 bg-gray-500 text-white rounded">No</button>
      </div>
    </div>
  </div>
</div>

<template id="network-setting-template">
  <div class="bg-white rounded-lg shadow p-4 relative">
    <div class="flex justify-between items-center border-b pb-2 mb-2">
      <h3 class="text-lg font-semibold scc-title">SCC</h3>
      <div class="flex items-center space-x-2">
        <label class="switch">
          <input type="checkbox" class="toggle-switch" checked>
          <span class="slider round"></span>
        </label>
        <button class="remove-card text-gray-500 text-xl">&times;</button>
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">IP Address</label>
      <input type="text" class="w-full p-1 border rounded input-field">
    </div>
    <div class="mt-2">
      <label class="block text-sm font-medium text-gray-700">Modbus Address</label>
      <input type="text" class="w-full p-1 border rounded input-field">
    </div>
    <div class="mt-4 flex justify-end space-x-2">
      <button class="save-btn px-4 py-2 bg-green-500 text-white rounded">Save</button>
      <button class="refresh-btn px-4 py-2 bg-blue-500 text-white rounded">Refresh</button>
    </div>
  </div>
</template>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const addButton = document.getElementById("add");
  const container = document.getElementById("network-settings-container");
  const template = document.getElementById("network-setting-template");
  const counterElement = document.getElementById("counter");
  const decreaseButton = document.getElementById("decrease");
  const increaseButton = document.getElementById("increase");
  const modal = document.getElementById("confirmation-modal");
  const confirmDelete = document.getElementById("confirm-delete");
  const cancelDelete = document.getElementById("cancel-delete");

  let count = 0;
  let sccNumbers = new Set([...document.querySelectorAll('[data-scc-number]')].map(el => 
    parseInt(el.dataset.sccNumber)
  ));
  let currentElementToDelete = null;

  function updateCounter(value) {
    count = Math.max(0, value);
    counterElement.value = count;
  }

  function getNextSccNumber() {
    let num = 1;
    while (sccNumbers.has(num)) {
      num++;
    }
    return num;
  }

  function addNetworkSetting(sccNumber = null) {
    if (template) {
      const clone = template.content.cloneNode(true);
      const newElement = clone.firstElementChild;
      const newSccNumber = sccNumber || getNextSccNumber();
      sccNumbers.add(newSccNumber);
      newElement.querySelector(".scc-title").textContent = `SCC${newSccNumber}`;
      newElement.dataset.sccNumber = newSccNumber;
      
      setupCardEventListeners(newElement);
      container.appendChild(newElement);
    }
  }

  function setupCardEventListeners(element) {
    const toggle = element.querySelector(".toggle-switch");
    const inputs = element.querySelectorAll(".input-field");
    const sccNumber = element.dataset.sccNumber;

    // Toggle switch
    toggle.addEventListener("change", function(event) {
      inputs.forEach(input => {
        input.disabled = !event.target.checked;
        input.classList.toggle("bg-gray-200", !event.target.checked);
      });
    });

    // Delete button
    const deleteBtn = element.querySelector(".remove-card");
    deleteBtn.addEventListener("click", function() {
      currentElementToDelete = element;
      modal.classList.remove("hidden");
    });

    // Save button
    const saveBtn = element.querySelector(".save-btn");
    saveBtn.addEventListener("click", function() {
      const data = {
        scc_number: parseInt(sccNumber),
        is_active: toggle.checked,
        ip_address: inputs[0].value,
        modbus_address: inputs[1].value
      };

      fetch("{{ url_for('settings.save_scc') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to save settings');
      });
    });

    // Refresh button
    const refreshBtn = element.querySelector(".refresh-btn");
    refreshBtn.addEventListener("click", function() {
      location.reload();
    });
  }

  // Set up event listeners for existing cards
  document.querySelectorAll('[data-scc-number]').forEach(setupCardEventListeners);

  confirmDelete.addEventListener("click", function() {
    if (currentElementToDelete) {
      const sccNumber = parseInt(currentElementToDelete.dataset.sccNumber);
      fetch(`{{ url_for('settings.delete_scc', scc_number=0) }}`.replace('0', sccNumber), {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          sccNumbers.delete(sccNumber);
          currentElementToDelete.remove();
          alert(data.message);
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete SCC');
      });
      currentElementToDelete = null;
    }
    modal.classList.add("hidden");
  });

  cancelDelete.addEventListener("click", function() {
    modal.classList.add("hidden");
  });

  counterElement.addEventListener("input", function() {
    const value = parseInt(counterElement.value) || 0;
    updateCounter(value);
  });

  increaseButton.addEventListener("click", function() {
    updateCounter(count + 1);
  });

  decreaseButton.addEventListener("click", function() {
    updateCounter(count - 1);
  });

  addButton.addEventListener("click", function() {
    if (count > 0) {
      for (let i = 0; i < count; i++) {
        addNetworkSetting();
      }
      updateCounter(0);
    }
  });
});
</script>

<style>
.switch {
  position: relative;
  display: inline-block;
  width: 34px;
  height: 20px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 20px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 14px;
  width: 14px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #4CAF50;
}

input:checked + .slider:before {
  transform: translateX(14px);
}
</style>
{% endblock %}